// FitDesk - Multi-tenant Gym Management SaaS
// PostgreSQL (Railway)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum Role {
  SUPER_ADMIN
  GYM_OWNER
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  password  String
  role      Role
  gymId     String?
  createdAt DateTime @default(now())

  gym  Gym?   @relation(fields: [gymId], references: [id], onDelete: Cascade)
  gyms Gym[]  @relation("GymOwner")
}

model Gym {
  id                    String   @id @default(cuid())
  name                  String
  ownerId               String
  subscriptionPlanId   String?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  isActive              Boolean  @default(true)
  invoiceLogoUrl        String?
  invoiceAddress        String?
  invoicePhone          String?
  invoiceEmail          String?
  gstNumber             String?
  createdAt             DateTime @default(now())

  owner            User     @relation("GymOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  subscriptionPlan SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id], onDelete: SetNull)
  users            User[]
  clients          Client[]
  trainers         Trainer[]

  @@index([ownerId])
  @@index([subscriptionPlanId])
}

model SubscriptionPlan {
  id             String   @id @default(cuid())
  name           String
  price          Decimal  @db.Decimal(10, 2)
  durationInDays Int
  features       Json     @default("[]")
  createdAt      DateTime @default(now())

  gyms Gym[]
}

model Client {
  id                    String             @id @default(cuid())
  gymId                 String
  fullName              String
  phone                 String?
  email                 String?
  address               String?
  profilePhoto          String?            // URL or path to uploaded image
  dateOfBirth           DateTime?
  joinDate              DateTime           @default(now())
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  subscriptionStatus    SubscriptionStatus @default(ACTIVE)
  totalAmount           Decimal            @default(0) @db.Decimal(10, 2)
  amountPaid            Decimal            @default(0) @db.Decimal(10, 2)
  createdAt             DateTime           @default(now())

  gym      Gym             @relation(fields: [gymId], references: [id], onDelete: Cascade)
  payments Payment[]
  history  ClientHistory[]

  @@index([gymId])
  @@index([subscriptionStatus])
  @@index([subscriptionEndDate])
}

model ClientHistory {
  id        String   @id @default(cuid())
  clientId  String
  message   String
  details   Json?
  createdAt DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([createdAt])
}

model Payment {
  id            String   @id @default(cuid())
  clientId      String
  amount        Decimal  @db.Decimal(10, 2)
  paymentDate   DateTime @default(now())
  paymentMethod String?
  createdAt     DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([paymentDate])
}

enum TrainerShift {
  MORNING
  EVENING
  CUSTOM
}

enum TrainerSalaryType {
  FIXED
  PER_SESSION
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

model Trainer {
  id             String           @id @default(cuid())
  gymId          String
  fullName       String
  phone          String?
  email          String?
  specialization String?          // Strength, Yoga, CrossFit, etc.
  shift          TrainerShift    @default(MORNING)
  shiftCustom    String?          // e.g. "10 AM - 2 PM" when shift = CUSTOM
  weeklyOff      Json?            // ["MON","TUE"] or [1,2] - stored as JSON array
  salaryType     TrainerSalaryType @default(FIXED)
  joiningDate    DateTime?
  profilePhoto   String?          // URL or path
  createdAt      DateTime        @default(now())

  gym         Gym                  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  attendance  TrainerAttendance[]

  @@index([gymId])
  @@index([shift])
  @@index([specialization])
}

model TrainerAttendance {
  id          String           @id @default(cuid())
  trainerId   String
  date        DateTime
  status      AttendanceStatus @default(PRESENT)
  checkInTime DateTime?
  checkOutTime DateTime?
  createdAt   DateTime         @default(now())

  trainer Trainer @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@unique([trainerId, date])
  @@index([trainerId])
  @@index([date])
}
